<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>项目管理之舟</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: #333;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: fixed;
        }
        
        .container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        header {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
            position: relative;
        }
        
        h1 {
            color: #1a2980;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h1 i {
            color: #26d0ce;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        button {
            background-color: #1a2980;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }
        
        button:hover {
            background-color: #2a3cb0;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        button#deleteLineBtn {
            background-color: #e74c3c;
        }
        
        button#deleteLineBtn:hover {
            background-color: #c0392b;
        }
        
        .content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }
        
        .cards-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }
        
        .card {
            position: absolute;
            width: 180px;
            min-height: 140px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 15px;
            cursor: move;
            pointer-events: auto;
            transition: box-shadow 0.3s ease;
            user-select: none;
            z-index: 10;
        }
        
        .card:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .card.dragging {
            opacity: 0.9;
            z-index: 100;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .card-title {
            font-weight: 700;
            font-size: 1rem;
            line-height: 1.3;
            color: #1a2980;
        }
        
        .card-subtitle {
            font-weight: 600;
            font-size: 0.9rem;
            color: #26d0ce;
            margin-top: 5px;
        }
        
        /* 修改颜色选择器为2行3列布局 */
        .color-picker {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }
        
        .color-row {
            display: flex;
            justify-content: space-between;
            gap: 5px;
        }
        
        .color-option {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s ease;
            flex-shrink: 0;
        }
        
        .color-option:hover {
            transform: scale(1.2);
        }
        
        .color-option.selected {
            border-color: #333;
            transform: scale(1.1);
        }
        
        .connection-points {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        
        .connection-point {
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: rgba(26, 41, 128, 0.7);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: auto;
            cursor: crosshair;
            z-index: 5;
            border: 2px solid white;
        }
        
        .connection-point:hover {
            background-color: #1a2980;
            transform: translate(-50%, -50%) scale(1.2);
        }
        
        .line-type-selector {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            z-index: 50;
            width: 260px;
        }
        
        .line-type-selector h3 {
            margin-bottom: 12px;
            color: #1a2980;
            font-size: 1.1rem;
        }
        
        .line-type-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .line-type-btn {
            padding: 8px 12px;
            background-color: #f0f0f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .line-type-btn:hover {
            background-color: #e0e0e0;
        }
        
        .line-type-btn.active {
            background-color: #1a2980;
            color: white;
        }
        
        .annotation-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 200;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal h2 {
            color: #1a2980;
            margin-bottom: 15px;
        }
        
        .modal p {
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 25px;
        }
        
        .export-options {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        footer {
            text-align: center;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            font-size: 0.85rem;
            color: #666;
            z-index: 100;
            position: relative;
        }
        
        @media (max-width: 768px) {
            .card {
                width: 160px;
                min-height: 140px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            button {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            
            .line-type-selector {
                width: 240px;
            }
            
            .color-option {
                width: 20px;
                height: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-ship"></i> 项目管理之舟</h1>
            <div class="controls">
                <button id="helpBtn">
                    <i class="fas fa-question-circle"></i> 帮助
                </button>
                <button id="deleteLineBtn">
                    <i class="fas fa-trash-alt"></i> 删除连线
                </button>
                <button id="exportBtn">
                    <i class="fas fa-download"></i> 导出结果
                </button>
            </div>
        </header>
        
        <div class="content">
            <canvas id="canvas"></canvas>
            <div class="cards-container" id="cardsContainer">
                <!-- 卡片将通过JS动态生成 -->
            </div>
            
            <div class="line-type-selector">
                <h3><i class="fas fa-project-diagram"></i> 连线工具</h3>
                <div class="line-type-options">
                    <div class="line-type-btn active" data-type="straight">直线</div>
                    <div class="line-type-btn" data-type="straight-arrow">单向箭头</div>
                    <div class="line-type-btn" data-type="straight-double-arrow">双向箭头</div>
                    <div class="line-type-btn" data-type="polyline">折线</div>
                    <div class="line-type-btn" data-type="polyline-arrow">折线箭头</div>
                </div>
                <input type="text" class="annotation-input" id="lineAnnotation" placeholder="输入连线注释文字...">
            </div>
        </div>
        
        <footer>
            <p>拖动卡片移动位置 | 点击颜色圆点更改卡片底色 | 点击卡片边上的连接点创建连线</p>
        </footer>
        
        <!-- 帮助模态框 -->
        <div class="modal" id="helpModal">
            <div class="modal-content">
                <h2><i class="fas fa-life-ring"></i> 游戏使用说明</h2>
                <p><strong>项目管理之舟</strong>是一个互动式的项目管理知识图谱构建工具。</p>
                <ul style="margin-left: 20px; margin-bottom: 20px;">
                    <li><strong>移动卡片</strong>：拖动卡片到任意位置</li>
                    <li><strong>更改颜色</strong>：点击卡片下方的颜色圆点（每行3个，共2行）</li>
                    <li><strong>创建连线</strong>：点击卡片边缘的连接点，然后点击另一个卡片的连接点</li>
                    <li><strong>选择连线类型</strong>：使用左侧的连线工具选择直线、箭头或折线</li>
                    <li><strong>添加注释</strong>：在连线工具中输入文字，创建连线时会自动添加</li>
                    <li><strong>删除连线</strong>：点击"删除连线"按钮，然后点击要删除的连线</li>
                    <li><strong>导出结果</strong>：点击"导出结果"按钮，可以保存为JPG图片或XML文件</li>
                </ul>
                <div class="modal-buttons">
                    <button id="closeHelpBtn">关闭</button>
                </div>
            </div>
        </div>
        
        <!-- 导出模态框 -->
        <div class="modal" id="exportModal">
            <div class="modal-content">
                <h2><i class="fas fa-file-export"></i> 导出结果</h2>
                <p>选择导出格式，将您的项目管理之舟图表保存到本地。</p>
                <div class="export-options">
                    <button id="exportJPG">
                        <i class="fas fa-file-image"></i> 导出为JPG图片
                    </button>
                    <button id="exportXML">
                        <i class="fas fa-file-code"></i> 导出为XML文件
                    </button>
                </div>
                <div class="modal-buttons">
                    <button id="closeExportBtn">取消</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 卡片数据
        const cardsData = [
            { id: 1, title: "花多长时间做？", subtitle: "进度管理" },
            { id: 2, title: "如何实现整体最优？", subtitle: "整合管理" },
            { id: 3, title: "如何才满意？", subtitle: "价值管理" },
            { id: 4, title: "谁来做？", subtitle: "资源与采购管理" },
            { id: 5, title: "按什么质量做？", subtitle: "质量管理" },
            { id: 6, title: "做什么？", subtitle: "范围管理" },
            { id: 7, title: "为谁做？", subtitle: "干系人管理" },
            { id: 8, title: "如何协作？", subtitle: "沟通管理" },
            { id: 9, title: "用多少成本做？", subtitle: "成本管理" },
            { id: 10, title: "有哪些人/财/事会增加难度？", subtitle: "风险管理" }
        ];

        // 颜色选项
        const colorOptions = [
            '#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0', '#118AB2', '#9D4EDD'
        ];

        // 全局变量
        let cards = [];
        let connections = [];
        let selectedLineType = 'straight';
        let isDrawingLine = false;
        let currentLineStart = null;
        let isDeletingLine = false;
        let canvas, ctx;
        let draggedCard = null;
        let dragOffsetX = 0, dragOffsetY = 0;

        // DOM 加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

        function initApp() {
            // 初始化Canvas
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // 创建卡片
            createCards();
            
            // 初始化事件监听
            initEventListeners();
            
            // 绘制初始连线
            draw();
        }

        // 调整Canvas大小
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            draw();
        }

        // 创建卡片
        function createCards() {
            const container = document.getElementById('cardsContainer');
            
            // 初始位置（网格布局）
            const positions = [
                { left: 5, top: 10 },   // 卡片1
                { left: 25, top: 10 },  // 卡片2
                { left: 45, top: 10 },  // 卡片3
                { left: 65, top: 10 },  // 卡片4
                { left: 85, top: 10 },  // 卡片5
                { left: 5, top: 40 },   // 卡片6
                { left: 25, top: 40 },  // 卡片7
                { left: 45, top: 40 },  // 卡片8
                { left: 65, top: 40 },  // 卡片9
                { left: 85, top: 40 }   // 卡片10
            ];
            
            cardsData.forEach((cardData, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.id = `card-${cardData.id}`;
                card.style.left = `${positions[index].left}%`;
                card.style.top = `${positions[index].top}%`;
                card.style.backgroundColor = colorOptions[index % colorOptions.length];
                
                // 创建2行3列的颜色选择器
                let colorPickerHTML = '<div class="color-picker">';
                
                // 第一行（前3个颜色）
                colorPickerHTML += '<div class="color-row">';
                for (let i = 0; i < 3; i++) {
                    const color = colorOptions[i];
                    const isSelected = (index % colorOptions.length) === i;
                    colorPickerHTML += `
                        <div class="color-option ${isSelected ? 'selected' : ''}" 
                             style="background-color: ${color}" 
                             data-color="${color}" data-index="${i}"></div>
                    `;
                }
                colorPickerHTML += '</div>';
                
                // 第二行（后3个颜色）
                colorPickerHTML += '<div class="color-row">';
                for (let i = 3; i < 6; i++) {
                    const color = colorOptions[i];
                    const isSelected = (index % colorOptions.length) === i;
                    colorPickerHTML += `
                        <div class="color-option ${isSelected ? 'selected' : ''}" 
                             style="background-color: ${color}" 
                             data-color="${color}" data-index="${i}"></div>
                    `;
                }
                colorPickerHTML += '</div>';
                
                colorPickerHTML += '</div>';
                
                card.innerHTML = `
                    <div class="card-header">
                        <div>
                            <div class="card-title">${cardData.title}</div>
                            <div class="card-subtitle">${cardData.subtitle}</div>
                        </div>
                    </div>
                    ${colorPickerHTML}
                    <div class="connection-points">
                        <div class="connection-point" data-side="top" style="top: 0; left: 50%;"></div>
                        <div class="connection-point" data-side="right" style="top: 50%; left: 100%;"></div>
                        <div class="connection-point" data-side="bottom" style="top: 100%; left: 50%;"></div>
                        <div class="connection-point" data-side="left" style="top: 50%; left: 0;"></div>
                    </div>
                `;
                
                container.appendChild(card);
                
                // 存储卡片数据
                cards.push({
                    id: cardData.id,
                    element: card,
                    title: cardData.title,
                    subtitle: cardData.subtitle,
                    x: positions[index].left,
                    y: positions[index].top,
                    color: colorOptions[index % colorOptions.length],
                    width: 180,
                    height: 140
                });
                
                // 添加卡片事件监听
                addCardEventListeners(card, cardData.id);
            });
            
            // 创建一些示例连线
            createExampleConnections();
        }

        // 添加卡片事件监听
        function addCardEventListeners(cardElement, cardId) {
            // 拖拽开始
            cardElement.addEventListener('mousedown', startDrag);
            cardElement.addEventListener('touchstart', startDragTouch);
            
            // 颜色选择
            const colorOptions = cardElement.querySelectorAll('.color-option');
            colorOptions.forEach(option => {
                option.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const color = this.getAttribute('data-color');
                    cardElement.style.backgroundColor = color;
                    
                    // 更新卡片数据
                    const card = cards.find(c => c.id === cardId);
                    if (card) {
                        card.color = color;
                    }
                    
                    // 更新选中状态
                    colorOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    draw();
                });
            });
            
            // 连接点点击事件
            const connectionPoints = cardElement.querySelectorAll('.connection-point');
            connectionPoints.forEach(point => {
                point.addEventListener('click', function(e) {
                    e.stopPropagation();
                    handleConnectionPointClick(cardId, this.getAttribute('data-side'));
                });
                
                // 防止拖拽时触发连接点事件
                point.addEventListener('mousedown', function(e) {
                    e.stopPropagation();
                });
                
                point.addEventListener('touchstart', function(e) {
                    e.stopPropagation();
                });
            });
        }

        // 开始拖拽（鼠标）
        function startDrag(e) {
            if (isDrawingLine || isDeletingLine) return;
            
            draggedCard = e.currentTarget;
            const cardId = parseInt(draggedCard.id.split('-')[1]);
            const card = cards.find(c => c.id === cardId);
            
            // 计算偏移量
            const rect = draggedCard.getBoundingClientRect();
            dragOffsetX = e.clientX - rect.left;
            dragOffsetY = e.clientY - rect.top;
            
            draggedCard.classList.add('dragging');
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
            
            e.preventDefault();
        }

        // 开始拖拽（触摸）
        function startDragTouch(e) {
            if (isDrawingLine || isDeletingLine) return;
            
            draggedCard = e.currentTarget;
            const cardId = parseInt(draggedCard.id.split('-')[1]);
            const card = cards.find(c => c.id === cardId);
            
            const touch = e.touches[0];
            const rect = draggedCard.getBoundingClientRect();
            dragOffsetX = touch.clientX - rect.left;
            dragOffsetY = touch.clientY - rect.top;
            
            draggedCard.classList.add('dragging');
            
            document.addEventListener('touchmove', dragTouch);
            document.addEventListener('touchend', stopDragTouch);
            
            e.preventDefault();
        }

        // 拖拽（鼠标）
        function drag(e) {
            if (!draggedCard) return;
            
            const containerRect = document.querySelector('.content').getBoundingClientRect();
            const cardWidth = draggedCard.offsetWidth;
            const cardHeight = draggedCard.offsetHeight;
            
            // 计算新位置
            let newLeft = e.clientX - dragOffsetX - containerRect.left;
            let newTop = e.clientY - dragOffsetY - containerRect.top;
            
            // 限制在容器内
            newLeft = Math.max(0, Math.min(newLeft, containerRect.width - cardWidth));
            newTop = Math.max(0, Math.min(newTop, containerRect.height - cardHeight));
            
            // 应用新位置
            draggedCard.style.left = `${newLeft}px`;
            draggedCard.style.top = `${newTop}px`;
            
            // 更新卡片数据
            const cardId = parseInt(draggedCard.id.split('-')[1]);
            const card = cards.find(c => c.id === cardId);
            if (card) {
                card.x = (newLeft / containerRect.width) * 100;
                card.y = (newTop / containerRect.height) * 100;
            }
            
            draw();
        }

        // 拖拽（触摸）
        function dragTouch(e) {
            if (!draggedCard) return;
            
            const touch = e.touches[0];
            const containerRect = document.querySelector('.content').getBoundingClientRect();
            const cardWidth = draggedCard.offsetWidth;
            const cardHeight = draggedCard.offsetHeight;
            
            // 计算新位置
            let newLeft = touch.clientX - dragOffsetX - containerRect.left;
            let newTop = touch.clientY - dragOffsetY - containerRect.top;
            
            // 限制在容器内
            newLeft = Math.max(0, Math.min(newLeft, containerRect.width - cardWidth));
            newTop = Math.max(0, Math.min(newTop, containerRect.height - cardHeight));
            
            // 应用新位置
            draggedCard.style.left = `${newLeft}px`;
            draggedCard.style.top = `${newTop}px`;
            
            // 更新卡片数据
            const cardId = parseInt(draggedCard.id.split('-')[1]);
            const card = cards.find(c => c.id === cardId);
            if (card) {
                card.x = (newLeft / containerRect.width) * 100;
                card.y = (newTop / containerRect.height) * 100;
            }
            
            draw();
        }

        // 停止拖拽（鼠标）
        function stopDrag() {
            if (draggedCard) {
                draggedCard.classList.remove('dragging');
                draggedCard = null;
            }
            
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDrag);
        }

        // 停止拖拽（触摸）
        function stopDragTouch() {
            if (draggedCard) {
                draggedCard.classList.remove('dragging');
                draggedCard = null;
            }
            
            document.removeEventListener('touchmove', dragTouch);
            document.removeEventListener('touchend', stopDragTouch);
        }

        // 处理连接点点击
        function handleConnectionPointClick(cardId, side) {
            if (isDeletingLine) {
                // 删除连线模式 - 通过点击连线来删除
                return;
            }
            
            const card = cards.find(c => c.id === cardId);
            if (!card) return;
            
            // 获取连接点位置
            const pointPos = getConnectionPointPosition(card, side);
            
            if (!isDrawingLine) {
                // 开始画线
                currentLineStart = { cardId, side, x: pointPos.x, y: pointPos.y };
                isDrawingLine = true;
                
                // 更新UI提示
                document.querySelectorAll('.connection-point').forEach(p => {
                    p.style.backgroundColor = 'rgba(26, 41, 128, 0.9)';
                });
            } else {
                // 结束画线
                if (currentLineStart.cardId === cardId) {
                    // 不能连接同一个卡片
                    isDrawingLine = false;
                    currentLineStart = null;
                    
                    // 重置UI
                    document.querySelectorAll('.connection-point').forEach(p => {
                        p.style.backgroundColor = 'rgba(26, 41, 128, 0.7)';
                    });
                    return;
                }
                
                // 创建新连线
                const annotation = document.getElementById('lineAnnotation').value;
                const newConnection = {
                    id: connections.length + 1,
                    from: currentLineStart.cardId,
                    fromSide: currentLineStart.side,
                    to: cardId,
                    toSide: side,
                    type: selectedLineType,
                    annotation: annotation,
                    color: '#1a2980'
                };
                
                connections.push(newConnection);
                
                // 重置状态
                isDrawingLine = false;
                currentLineStart = null;
                
                // 清空注释输入框
                document.getElementById('lineAnnotation').value = '';
                
                // 重置UI
                document.querySelectorAll('.connection-point').forEach(p => {
                    p.style.backgroundColor = 'rgba(26, 41, 128, 0.7)';
                });
                
                // 重新绘制
                draw();
            }
        }

        // 获取连接点位置
        function getConnectionPointPosition(card, side) {
            const containerRect = document.querySelector('.content').getBoundingClientRect();
            const cardElement = document.getElementById(`card-${card.id}`);
            const cardRect = cardElement.getBoundingClientRect();
            
            let x, y;
            
            switch(side) {
                case 'top':
                    x = cardRect.left + cardRect.width / 2;
                    y = cardRect.top;
                    break;
                case 'right':
                    x = cardRect.left + cardRect.width;
                    y = cardRect.top + cardRect.height / 2;
                    break;
                case 'bottom':
                    x = cardRect.left + cardRect.width / 2;
                    y = cardRect.top + cardRect.height;
                    break;
                case 'left':
                    x = cardRect.left;
                    y = cardRect.top + cardRect.height / 2;
                    break;
            }
            
            // 转换为相对于Canvas的坐标
            return {
                x: x - containerRect.left,
                y: y - containerRect.top
            };
        }

        // 创建示例连线
        function createExampleConnections() {
            // 添加一些示例连线
            connections = [
                {
                    id: 1,
                    from: 1,
                    fromSide: 'right',
                    to: 6,
                    toSide: 'top',
                    type: 'straight-arrow',
                    annotation: '决定工作范围',
                    color: '#1a2980'
                },
                {
                    id: 2,
                    from: 6,
                    fromSide: 'bottom',
                    to: 9,
                    toSide: 'left',
                    type: 'straight-arrow',
                    annotation: '影响成本',
                    color: '#FF6B6B'
                },
                {
                    id: 3,
                    from: 5,
                    fromSide: 'left',
                    to: 6,
                    toSide: 'right',
                    type: 'straight-double-arrow',
                    annotation: '相互影响',
                    color: '#06D6A0'
                },
                {
                    id: 4,
                    from: 10,
                    fromSide: 'bottom',
                    to: 9,
                    toSide: 'top',
                    type: 'polyline-arrow',
                    annotation: '增加成本风险',
                    color: '#9D4EDD'
                }
            ];
        }

        // 绘制Canvas
        function draw() {
            // 清除Canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 绘制所有连线
            connections.forEach(connection => {
                drawConnection(connection);
            });
            
            // 如果正在画线，绘制预览线
            if (isDrawingLine && currentLineStart) {
                drawPreviewLine();
            }
        }

        // 绘制连线
        function drawConnection(conn) {
            const fromCard = cards.find(c => c.id === conn.from);
            const toCard = cards.find(c => c.id === conn.to);
            
            if (!fromCard || !toCard) return;
            
            // 获取起点和终点坐标
            const startPos = getConnectionPointPosition(fromCard, conn.fromSide);
            const endPos = getConnectionPointPosition(toCard, conn.toSide);
            
            // 设置连线样式
            ctx.strokeStyle = conn.color;
            ctx.lineWidth = 2;
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            
            // 根据连线类型绘制
            if (conn.type.includes('polyline')) {
                drawPolyline(startPos, endPos, conn.fromSide, conn.toSide, conn.type.includes('arrow'));
            } else {
                drawStraightLine(startPos, endPos, conn.type.includes('arrow'), conn.type.includes('double'));
            }
            
            // 绘制注释文字
            if (conn.annotation) {
                drawAnnotation(startPos, endPos, conn.annotation, conn.type.includes('polyline'));
            }
            
            // 如果处于删除模式，添加悬停效果
            if (isDeletingLine) {
                // 在实际应用中，可以添加悬停检测
            }
        }

        // 绘制直线
        function drawStraightLine(start, end, hasArrow, isDoubleArrow) {
            ctx.beginPath();
            ctx.moveTo(start.x, start.y);
            ctx.lineTo(end.x, end.y);
            ctx.stroke();
            
            if (hasArrow) {
                drawArrow(end, start, isDoubleArrow);
                if (isDoubleArrow) {
                    drawArrow(start, end, false);
                }
            }
        }

        // 绘制折线
        function drawPolyline(start, end, startSide, endSide, hasArrow) {
            // 计算中间点
            const midX1 = startSide === 'left' || startSide === 'right' ? 
                         (start.x + end.x) / 2 : start.x;
            const midY1 = startSide === 'top' || startSide === 'bottom' ? 
                         (start.y + end.y) / 2 : start.y;
            
            const midX2 = endSide === 'left' || endSide === 'right' ? 
                         (start.x + end.x) / 2 : end.x;
            const midY2 = endSide === 'top' || endSide === 'bottom' ? 
                         (start.y + end.y) / 2 : end.y;
            
            ctx.beginPath();
            ctx.moveTo(start.x, start.y);
            
            // 水平或垂直折线
            if (startSide === 'left' || startSide === 'right') {
                ctx.lineTo(midX1, start.y);
                ctx.lineTo(midX1, end.y);
                ctx.lineTo(end.x, end.y);
            } else {
                ctx.lineTo(start.x, midY1);
                ctx.lineTo(end.x, midY1);
                ctx.lineTo(end.x, end.y);
            }
            
            ctx.stroke();
            
            if (hasArrow) {
                drawArrow(end, {x: midX2, y: midY2}, false);
            }
        }

        // 绘制箭头
        function drawArrow(from, to, isDouble) {
            const headlen = 15;
            const dx = to.x - from.x;
            const dy = to.y - from.y;
            const angle = Math.atan2(dy, dx);
            
            ctx.beginPath();
            ctx.moveTo(from.x, from.y);
            ctx.lineTo(
                from.x - headlen * Math.cos(angle - Math.PI / 6),
                from.y - headlen * Math.sin(angle - Math.PI / 6)
            );
            ctx.moveTo(from.x, from.y);
            ctx.lineTo(
                from.x - headlen * Math.cos(angle + Math.PI / 6),
                from.y - headlen * Math.sin(angle + Math.PI / 6)
            );
            ctx.stroke();
        }

        // 绘制注释
        function drawAnnotation(start, end, text, isPolyline) {
            let x, y;
            
            if (isPolyline) {
                // 折线注释放在中间
                x = (start.x + end.x) / 2;
                y = (start.y + end.y) / 2 - 10;
            } else {
                // 直线注释放在中间
                x = (start.x + end.x) / 2;
                y = (start.y + end.y) / 2 - 10;
            }
            
            ctx.font = '12px Arial';
            ctx.fillStyle = '#333';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // 绘制文字背景
            const textWidth = ctx.measureText(text).width;
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.fillRect(x - textWidth/2 - 5, y - 10, textWidth + 10, 20);
            
            // 绘制文字
            ctx.fillStyle = '#333';
            ctx.fillText(text, x, y);
        }

        // 绘制预览线
        function drawPreviewLine() {
            // 获取鼠标位置
            const mouseX = canvas.width / 2; // 简化处理，实际应该获取鼠标位置
            const mouseY = canvas.height / 2;
            
            ctx.strokeStyle = 'rgba(255, 107, 107, 0.7)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            
            ctx.beginPath();
            ctx.moveTo(currentLineStart.x, currentLineStart.y);
            ctx.lineTo(mouseX, mouseY);
            ctx.stroke();
            
            ctx.setLineDash([]);
            
            // 根据连线类型绘制预览箭头
            if (selectedLineType.includes('arrow')) {
                drawArrow({x: mouseX, y: mouseY}, currentLineStart, selectedLineType.includes('double'));
                if (selectedLineType.includes('double')) {
                    drawArrow(currentLineStart, {x: mouseX, y: mouseY}, false);
                }
            }
        }

        // 初始化事件监听
        function initEventListeners() {
            // 连线类型选择
            document.querySelectorAll('.line-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.line-type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedLineType = this.getAttribute('data-type');
                });
            });
            
            // 帮助按钮
            document.getElementById('helpBtn').addEventListener('click', function() {
                document.getElementById('helpModal').style.display = 'flex';
            });
            
            // 关闭帮助
            document.getElementById('closeHelpBtn').addEventListener('click', function() {
                document.getElementById('helpModal').style.display = 'none';
            });
            
            // 删除连线按钮
            document.getElementById('deleteLineBtn').addEventListener('click', function() {
                isDeletingLine = !isDeletingLine;
                isDrawingLine = false;
                currentLineStart = null;
                
                if (isDeletingLine) {
                    this.style.backgroundColor = '#2ecc71';
                    this.innerHTML = '<i class="fas fa-check-circle"></i> 选择要删除的连线';
                    
                    // 添加点击连线删除功能
                    canvas.addEventListener('click', handleLineClickForDeletion);
                } else {
                    this.style.backgroundColor = '#e74c3c';
                    this.innerHTML = '<i class="fas fa-trash-alt"></i> 删除连线';
                    
                    // 移除点击连线删除功能
                    canvas.removeEventListener('click', handleLineClickForDeletion);
                }
            });
            
            // 导出按钮
            document.getElementById('exportBtn').addEventListener('click', function() {
                document.getElementById('exportModal').style.display = 'flex';
            });
            
            // 关闭导出模态框
            document.getElementById('closeExportBtn').addEventListener('click', function() {
                document.getElementById('exportModal').style.display = 'none';
            });
            
            // 导出为JPG
            document.getElementById('exportJPG').addEventListener('click', exportAsJPG);
            
            // 导出为XML
            document.getElementById('exportXML').addEventListener('click', exportAsXML);
            
            // 点击模态框外部关闭
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
        }

        // 处理连线点击以删除
        function handleLineClickForDeletion(e) {
            // 在实际应用中，这里需要检测点击位置是否在连线上
            // 简化处理：删除最后一条连线
            if (connections.length > 0) {
                connections.pop();
                draw();
            }
        }

        // 导出为JPG
        function exportAsJPG() {
            // 在实际应用中，可以使用html2canvas库来截图整个游戏区域
            // 这里简化处理，提示用户截图
            alert('在真实部署中，这里会使用html2canvas库将整个游戏区域转换为JPG图片并下载。\n\n当前为演示版本，请使用浏览器截图功能（Ctrl+Shift+S）保存页面为图片。');
            document.getElementById('exportModal').style.display = 'none';
        }

        // 导出为XML
        function exportAsXML() {
            // 创建XML结构
            let xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
            xml += '<project-management-ship>\n';
            
            // 添加卡片数据
            xml += '  <cards>\n';
            cards.forEach(card => {
                xml += `    <card id="${card.id}">\n`;
                xml += `      <title>${card.title}</title>\n`;
                xml += `      <subtitle>${card.subtitle}</subtitle>\n`;
                xml += `      <position x="${card.x.toFixed(2)}" y="${card.y.toFixed(2)}" />\n`;
                xml += `      <color>${card.color}</color>\n`;
                xml += `    </card>\n`;
            });
            xml += '  </cards>\n';
            
            // 添加连线数据
            xml += '  <connections>\n';
            connections.forEach(conn => {
                xml += `    <connection id="${conn.id}">\n`;
                xml += `      <from card="${conn.from}" side="${conn.fromSide}" />\n`;
                xml += `      <to card="${conn.to}" side="${conn.toSide}" />\n`;
                xml += `      <type>${conn.type}</type>\n`;
                xml += `      <annotation>${conn.annotation}</annotation>\n`;
                xml += `      <color>${conn.color}</color>\n`;
                xml += `    </connection>\n`;
            });
            xml += '  </connections>\n';
            
            xml += '</project-management-ship>';
            
            // 创建下载链接
            const blob = new Blob([xml], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '项目管理之舟-图表.xml';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            document.getElementById('exportModal').style.display = 'none';
        }
    </script>
</body>
</html>
